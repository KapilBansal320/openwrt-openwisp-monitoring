#!/bin/sh

while [ -n "$1" ]; do
	case "$1" in
		--url) export BASE_URL="$2"; shift;;
		--uuid) export UUID="$2"; shift;;
		--key) export KEY="$2"; shift;;
		--verify-ssl) export verify_ssl="$2"; shift;;
		--interval) export INTERVAL="$2"; shift;;
		--monitored_interfaces) export MONITORED_INTERFACES=$2; shift;;
		-*)
			echo "Invalid option: $1"
			exit 1
		;;
		*) break;
	esac
	shift;
done

if [ "$verify_ssl" = 0 ]; then
    curl_command='curl -k'
else
    curl_command='curl'
fi

url="$BASE_URL/api/v1/monitoring/device/$UUID/?key=$KEY"

while true
do
	data=$(/usr/sbin/netjson_monitoring "$MONITORED_INTERFACES")
	#send data
	$($curl_command -H "Content-Type: application/json" \
					-X POST \
					-d "$data" \
					-v "$url")
	sleep "$INTERVAL" & wait $!
done
